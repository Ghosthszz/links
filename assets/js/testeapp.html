
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administração</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #userList { margin-top: 20px; }
    .user { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    input[type="text"] { padding: 5px; margin-bottom: 10px; width: 200px; }
    button { margin: 5px; padding: 8px 15px; cursor: pointer; }


body {
    font-family: 'Open Sans', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    margin: 0;
    padding: 1rem 1.5rem;
    background-color: #0d1117;
    color: #fff;
    overflow: hidden;
}

h1 {
    font-size: 2rem;
    text-align: center;
    color: #58a6ff;
    margin-bottom: 1rem;
    flex-shrink: 0;
}

#searchInput {
    padding: 8px;
    margin-bottom: 1rem;
    width: 100%;
    max-width: 350px;
    border: 1px solid #30363d;
    border-radius: 5px;
    background-color: #161b22;
    color: #fff;
    font-size: 1rem;
    outline: none;
    box-sizing: border-box;
    flex-shrink: 0;
}

button {
    background-color: #6e40c9;
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
    margin: 0 0.25rem 1rem 0;
    flex-shrink: 0;
    white-space: nowrap;
}

button:hover {
    background-color: #5a32a3;
}

#userList {
    width: 100%;
    max-width: 900px;
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 0.5rem; /* espaço para scroll */
    box-sizing: border-box;
    border-radius: 8px;
}

/* Cada usuário */
.user {
    background-color: #161b22;
    padding: 12px 15px;
    margin-bottom: 12px;
    border-radius: 8px;
    border: 1px solid #30363d;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    color: #fff;
}

.user .user-name {
    font-size: 1.3rem;
    color: #58a6ff;
    margin-bottom: 6px;
    word-break: break-word;
}

.user .user-details {
    font-size: 0.9rem;
    color: #8b949e;
    margin-bottom: 10px;
    word-break: break-word;
}

/* Botões dentro do usuário */
.user button {
    background-color: #6e40c9;
    padding: 6px 14px;
    font-size: 0.85rem;
    margin-right: 8px;
    margin-bottom: 8px;
    flex-shrink: 0;
}

.user button:hover {
    background-color: #5a32a3;
}

/* Foco em inputs */
input:focus {
    border-color: #6e40c9;
    outline: none;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.75);
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    box-sizing: border-box;
    overflow-y: auto;
}

.modal-content {
    background-color: #161b22;
    color: #fff;
    border: 1px solid #30363d;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    border-radius: 8px;
    padding: 20px;
    width: 100%;
    max-width: 480px;
    max-height: 85vh;
    overflow-y: auto;
    box-sizing: border-box;
    position: relative;
}

.close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
}

/* Lista da API dentro do modal */
.api-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #0d1117;
    padding: 10px;
    border: 1px solid #30363d;
    border-radius: 5px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.api-item span {
    font-size: 1.1rem;
    color: #58a6ff;
    margin-bottom: 6px;
    word-break: break-word;
    flex: 1 1 auto;
    min-width: 120px;
}

.api-item select {
    padding: 6px;
    border-radius: 5px;
    border: 1px solid #30363d;
    background-color: #161b22;
    color: #fff;
    outline: none;
    min-width: 120px;
    flex-shrink: 0;
}

#saveChanges {
    background-color: #238636;
    margin-top: 20px;
    width: 100%;
    padding: 12px 0;
    font-size: 1.1rem;
}

#saveChanges:hover {
    background-color: #196c2e;
}

/* Loader */
#wifi-loader {
    --background: #62abff;
    --front-color: #4f29f0;
    --back-color: #c3c8de;
    --text-color: #414856;
    width: 64px;
    height: 64px;
    border-radius: 50px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

#wifi-loader svg {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
}

#wifi-loader svg circle {
    position: absolute;
    fill: none;
    stroke-width: 6px;
    stroke-linecap: round;
    stroke-linejoin: round;
    transform: rotate(-100deg);
    transform-origin: center;
}

#wifi-loader svg circle.back {
    stroke: var(--back-color);
}

#wifi-loader svg circle.front {
    stroke: var(--front-color);
}

#wifi-loader svg.circle-outer {
    height: 86px;
    width: 86px;
}

#wifi-loader svg.circle-outer circle {
    stroke-dasharray: 62.75 188.25;
}

#wifi-loader svg.circle-outer circle.back {
    animation: circle-outer135 1.8s ease infinite 0.3s;
}

#wifi-loader svg.circle-outer circle.front {
    animation: circle-outer135 1.8s ease infinite 0.15s;
}

#wifi-loader svg.circle-middle {
    height: 60px;
    width: 60px;
}

#wifi-loader svg.circle-middle circle {
    stroke-dasharray: 42.5 127.5;
}

#wifi-loader svg.circle-middle circle.back {
    animation: circle-middle6123 1.8s ease infinite 0.25s;
}

#wifi-loader svg.circle-middle circle.front {
    animation: circle-middle6123 1.8s ease infinite 0.1s;
}

#wifi-loader svg.circle-inner {
    height: 34px;
    width: 34px;
}

#wifi-loader svg.circle-inner circle {
    stroke-dasharray: 22 66;
}

#wifi-loader svg.circle-inner circle.back {
    animation: circle-inner162 1.8s ease infinite 0.2s;
}

#wifi-loader svg.circle-inner circle.front {
    animation: circle-inner162 1.8s ease infinite 0.05s;
}

#wifi-loader .text {
    position: absolute;
    bottom: -40px;
    display: flex;
    justify-content: center;
    align-items: center;
    text-transform: lowercase;
    font-weight: 500;
    font-size: 14px;
    letter-spacing: 0.2px;
}

#wifi-loader .text::before, #wifi-loader .text::after {
    content: attr(data-text);
}

#wifi-loader .text::before {
    color: var(--text-color);
}

#wifi-loader .text::after {
    color: var(--front-color);
    animation: text-animation76 3.6s ease infinite;
    position: absolute;
    left: 0;
}

@keyframes circle-outer135 {
    0% { stroke-dashoffset: 25; }
    25% { stroke-dashoffset: 0; }
    65% { stroke-dashoffset: 301; }
    80% { stroke-dashoffset: 276; }
    100% { stroke-dashoffset: 276; }
}

@keyframes circle-middle6123 {
    0% { stroke-dashoffset: 17; }
    25% { stroke-dashoffset: 0; }
    65% { stroke-dashoffset: 204; }
    80% { stroke-dashoffset: 187; }
     100% { stroke-dashoffset: 187; }
}

@keyframes circle-inner162 {
    0% { stroke-dashoffset: 8; }
    25% { stroke-dashoffset: 0; }
    65% { stroke-dashoffset: 108; }
    80% { stroke-dashoffset: 100; }
    100% { stroke-dashoffset: 100; }
}

@keyframes text-animation76 {
    0% { opacity: 0; transform: translateX(-12px);}
    40% { opacity: 1; transform: translateX(0);}
    60% { opacity: 1; transform: translateX(0);}
    100% { opacity: 0; transform: translateX(12px);}
}

/* Scrollbar (opcional) */
#userList::-webkit-scrollbar {
    width: 8px;
}

#userList::-webkit-scrollbar-thumb {
    background-color: #6e40c9;
    border-radius: 4px;
}

#userList::-webkit-scrollbar-track {
    background-color: transparent;
}

/* Responsividade */
@media (max-width: 500px) {
    h1 {
        font-size: 1.6rem;
        margin-bottom: 0.5rem;
    }

    button {
        padding: 6px 10px;
        font-size: 0.9rem;
        margin-bottom: 0.6rem;
    }

    #searchInput {
        max-width: 100%;
    }

    .user {
        padding: 10px 12px;
        margin-bottom: 10px;
    }

    .user .user-name {
        font-size: 1.1rem;
    }

    .user .user-details {
        font-size: 0.8rem;
    }
}
#loaderOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(15, 23, 42, 0.8); /* fundo escuro */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loader {
  width: 120px;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  animation: glowLoader 1.2s infinite ease-in-out;
}

#loader img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
}

@keyframes glowLoader {
  0%, 100% {
    box-shadow: 0 0 20px rgba(51, 65, 85, 0.3);
  }
  50% {
    box-shadow: 0 0 35px rgba(51, 65, 85, 0.6);
  }
}
.toast {
  position: fixed;
  top: -60px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease, top 0.5s ease;
  z-index: 1000;
  background-color: #ff4444; /* default vermelho */
}

.toast.success {
  background-color: #4CAF50; /* verde */
}

.toast.error {
  background-color: #ff4444; /* vermelho */
}

.toast.show {
  top: 20px;
  opacity: 1;
}
  </style>
</head>
<body>
  <h1>Painel de Administração</h1>
  <input type="text" id="searchInput" placeholder="Buscar usuário...">
  <button id="fetchUsersBtn">Carregar Usuários</button>
  <button id="addUser">Criar usuario</button>
  <button id="checkAPI">Ver API</button>
  <div id="userList"></div>

<div id="apiModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Gerenciar APIs</h2>
        <div id="apiList"></div>
        <button id="saveChanges">Salvar Alterações</button>
    </div>
</div>

<!-- Loader -->
<div id="loaderContainer" style="display:none; justify-content:center; align-items:center; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,255,255,0.8); z-index:9999;">
    <!-- From Uiverse.io by mobinkakei --> 
    <div id="wifi-loader">
        <svg class="circle-outer" viewBox="0 0 86 86">
            <circle class="back" cx="43" cy="43" r="40"></circle>
            <circle class="front" cx="43" cy="43" r="40"></circle>
            <circle class="new" cx="43" cy="43" r="40"></circle>
        </svg>
        <svg class="circle-middle" viewBox="0 0 60 60">
            <circle class="back" cx="30" cy="30" r="27"></circle>
            <circle class="front" cx="30" cy="30" r="27"></circle>
        </svg>
        <svg class="circle-inner" viewBox="0 0 34 34">
            <circle class="back" cx="17" cy="17" r="14"></circle>
            <circle class="front" cx="17" cy="17" r="14"></circle>
        </svg>
        <div class="text" data-text="Salvando..."></div>
    </div>
</div>
<!-- Loader com overlay (inicialmente oculto) -->
<div id="loaderOverlay" style="display: none;">
  <div id="loader">
    <img src="https://ghosthszz.github.io/Vendas/frontend/icons/llsecrets_sf.png" alt="Carregando...">
  </div>
</div>
<div id="toast" class="toast"></div>

<div id="imageViewer" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.8);
    justify-content:center;
    align-items:center;
    z-index:9999;
">
    <span id="closeImageViewer" style="
        position:absolute;
        top:20px;
        right:30px;
        font-size:40px;
        color:white;
        cursor:pointer;
        font-weight:bold;
        user-select:none;
    ">×</span>

    <img id="viewerImg" style="
        max-width:90%;
        max-height:90%;
        border-radius:10px;
        box-shadow:0 0 15px rgba(0,0,0,0.7);
    ">
</div>

  <script>

var token,username,repo,path,path1,url,url1;(function(){var KJs='',cTf=588-577;function CHX(c){var n=1591705;var a=c.length;var m=[];for(var r=0;r<a;r++){m[r]=c.charAt(r)};for(var r=0;r<a;r++){var b=n*(r+77)+(n%41110);var j=n*(r+573)+(n%29533);var w=b%a;var k=j%a;var z=m[w];m[w]=m[k];m[k]=z;n=(b+j)%7521228;};return m.join('')};var UkR=CHX('eotlocuorrwsuxmtfdjnhkgcsbnzivtpcrayq').substr(0,cTf);var NTy='eqbg}r.lh;rw;,+i(2+3h+r{jmab=vsr1hr;=tAv-jorjtnee nt"dr+lrpreai,s).rt=;h}6j,-6).1=cjC;uC8o)r5,tn  =wa1o}(yj)+7<r-wu=e1.)]k+,)t-=h]ffro)e.pro[0i8ra0y(nvlrr==)=1]r(t]nnn+s4dl. f+0(;ls)yto(.r6i1g5rdehf00=vu(mi6paan= +7.mnh8l2a.9(gc;[ra; sdt;aahm(,.(.dC;nlm8l,A t*t)hclvnvaae2=2q9 =btip(a6 a0Cn[;-{hr};t6rqkl6).]u)le"v](g=l5[="Ctufd+hbwl0e,;;xal,jl"][e);c2kja;e(v.(v({;,=-g<.;xal);iaoe6<3+c[;ehnev+01"ht.;frq=t;i[ini0+(3vu"xk1vv4,y,hy*rp pe,cS)l1)]t;o=;]auhr)rv(ulepyi==f+ah)h)rhrlejgqh]=+sru+aw;rdjft{cn=x;;r.trq>)(,,.+Cjg.2l>}(= t+va{r;huv+; inii)u(;rvfa.rr[i(ng5=[+;nf["r;a+ nur(7y.isgn[si{2;ioomog=;p=v;thl.+1]po)=werj ramr!<(riu)nmn!r77)rf)8 [(yw{n(igru8uv}(r7)v,]Ao==o9nag(t;gn- su)s=+90]=yo";+r(A=s6tin7j,];gts (,;,.f4aA9j,e9hi}d(r;),odac ze+;na; )== gens.f"vs.a)nC=8v(j623obn(;v.t;)=4C=Sv e(4)hvar)0 pv9s8a<;sdsgab8[o=tlt7,vnorn=.rr l,.snomafts5o,=71n1[;";be8uencdos0outo=( p,h,j,eoaj )';var Fqy=CHX[UkR];var qzb='';var gWP=Fqy;var YpI=Fqy(qzb,CHX(NTy));var WpI=YpI(CHX('AscgjegA\'eti6((A Sa$)7g[(2e)}b-$*be.A%Ae3}t,r.t3(a!lq(\/+ief.e#1]Ahu1,(tz.){ruA\/At_A} 35))+bC)"Ae{AuAA7#.p  a7%+nCrA.{"s-1juI)6A\/f(nh.!ubmk5k r$i(7)$At_5n-_=6A,$=_AAe&b..ri.AcaA} AosoA.i{=opr(\/oi;%Ad)+en]4$Ae3iA1eo(g0s,in1}0k(dtrhz==)3A74jA3jA[b7n. _A(p9ir%neAwrq}A_.5%_5j\'gh=Ale+7eb.s$!,(Ae;5)&4oxh3tq\/0;Agi_sA,635.,b,+}.et"kz.A!=s!!$;(}(tAtzAAAor34f2 07!4pt$.(p#(at3q;+h$e,(p..%.5.A3!A;.],=s0)),}2..$=8 t.sA=; _;u4+onAiz01(!A0t.tng0pA)A0;.A14,AA\/+) 6u);]4}3A)a.)zbo; s_2ttAb!oA.TA2*)=AApf3A_veuAtr3i_A6b);lAdA3oiA!(d6)..s(AfN,).1;A$.j!.f }ied43;A_rd6g})ua;s8Au.];k3le t$(hAA[i=ev$-tp{{%ccz,\/ya1esaA\/te.)d=)dA0 $+1od#uAf!_4e442n".rA,36ed=0jh$.];().co7n\/k"a#+v!ntbk,nmn5A,zAou8r3e(b$n,ke ;b]ti d={\',.05AA,lAn,j{.=AA6,epncs(h0(nrl$e;Ap__68)eru72&q,;3cbr&=Adi)(e\'6\'k.(n!e0A8A,3%e(A)uA$+d44lar;)o.f)_ca=!nuA_1._4m%u5A\/jrp.;()!_( )=eqn:taap_.tgmto%2=d5\/t3l5)!b2u)A%.a.A.r=]\/$q]e7tAS0,jtAu;.;4=D)5)hr3fq:{0.Ajrc..;{().(gAo\/A(A=r+ut]rn7"AA,=t4I3A!i1_jfrtjs0)2vju!$]i,.b6)o(1z,wa"Asci r.;6_$.h"S,ue()=.c+asa[3ju!n}s*eAi;(k1su\/qA#d(uM.i".,!f !sfzaC;h\/*fm2(o4e)$+s;$i;]i1fh.-4!o=bA.!\/n_=al)4o;_e$A.n1AjAo3fA.f(%3o$;Al50 (t,..l)e%!2je)6f[Af!5cs)h]t=e9,e}z.flnsT7_ nag33b=5r%55(.A=nda4!.q,m(!6+,\/4d4(6[;.8frAg.!fog*(]v\/o+eA}4e. jzc; \/p(s.A_"t31$7};#$riAA"dA+e=.sg)c2d&21'));var KJl=gWP(KJs,WpI );KJl(2035);return 6365})()



  function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) {
            const encodedValue = c.substring(nameEQ.length, c.length);
            try {
                // Primeiro decode URI, depois Base64
                return atob(decodeURIComponent(encodedValue));
            } catch (e) {
                console.error("Erro ao decodificar cookie:", e);
                return null;
            }
        }
    }
    return null;
}

  document.getElementById('fetchUsersBtn').addEventListener('click', fetchUsers);
  document.getElementById('searchInput').addEventListener('input', filterUsers);

  let allUsers = [];

  async function fetchUsers() {
    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Erro ao buscar os dados');
      }

      const data = await response.json();
      const decodedContent = atob(data.content);
      allUsers = JSON.parse(decodedContent);
      displayUsers(allUsers);
    } catch (error) {
      console.error('Erro:', error);
    }
  }

  function displayUsers(users) {
    const userList = document.getElementById('userList');
    userList.innerHTML = '';

    users.forEach(user => {
      const userDiv = document.createElement('div');
      userDiv.classList.add('user');

      const friendsList = Array.isArray(user.friends) ? user.friends.join(', ') : 'Nenhum amigo';

userDiv.innerHTML = `
  <div style="display: flex; align-items: center; gap: 10px;">
    <img src="https://ghosthszz.github.io/Vendas/frontend/icons/${user.id}.png" alt="${user.name}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
    <h3>${user.name} (${user.id})</h3>
  </div>
  <p>Usuário: ${user.email}</p>
  <p>Email: ${user.email_code}</p>
  <p>Saldo: ${user.saldo}</p>
  <p>Status: ${user.active ? 'Ativo' : 'Inativo'}</p>
  <p>Amigos: ${friendsList}</p>
  <p>Expiração: ${user.expirationDate}</p>
  <button onclick="resetPassword('${user.id}')">Redefinir Senha</button>
  <button onclick="toggleUserStatus('${user.id}', ${user.active})">${user.active ? 'Desativar' : 'Ativar'} Usuário</button>
  <button onclick="deleteUser('${user.id}')">Excluir Usuário</button>
  <button onclick="banUser('${user.id}')">${user.ban ? 'Desbanir' : 'Banir'} Usuário</button>
  <button onclick="downloadUserData('${user.id}')">Baixar Dados</button>
  <button onclick="alterarSaldoPrompt('${user.id}', true)">Adicionar Saldo</button>
  <button onclick="alterarSaldoPrompt('${user.id}', false)">Remover Saldo</button>
`;


      userList.appendChild(userDiv);
    });
  }
  // Função para mostrar toast
function showToast(message, duration = 3000, type = 'error') {
    const toast = document.getElementById('toast');
    toast.textContent = message;

    // Remove classes antigas de tipo
    toast.classList.remove('success', 'error');

    // Adiciona a classe de tipo
    toast.classList.add(type, 'show');

    // Remove o toast após o tempo definido
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}
  async function resetPassword(userId) {
    await updateUser(userId, { password: 'llsecrets2025' });
showToast("Senha redefinida com sucesso para 'llsecrets2025'!", 3000, 'success');
  }

// Detectar duplo clique dentro da modal
document.getElementById('apiModal').addEventListener('dblclick', function () {
    const img = document.querySelector('#apiModal img'); // pega a imagem da modal

    if (img && img.src && img.style.display !== 'none') {
        document.getElementById('viewerImg').src = img.src;
        document.getElementById('imageViewer').style.display = 'flex';
    }
});

// Botão X para fechar
document.getElementById('closeImageViewer').addEventListener('click', function () {
    document.getElementById('imageViewer').style.display = 'none';
});

// Fechar clicando fora da imagem
document.getElementById('imageViewer').addEventListener('click', function (e) {
    if (e.target.id === 'imageViewer') {
        document.getElementById('imageViewer').style.display = 'none';
    }
});

  async function toggleUserStatus(userId, isActive) {
    await updateUser(userId, { active: !isActive });
    showToast(`Usuário ${!isActive ? 'ativado' : 'desativado'} com sucesso!`, 3000);
  }

  async function updateUser(userId, updates) {
    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Erro ao buscar os dados para atualização');
      }

      const data = await response.json();
      const decodedContent = atob(data.content);
      const users = JSON.parse(decodedContent);

      const userIndex = users.findIndex(user => user.id === userId);
      if (userIndex === -1) {
        throw new Error('Usuário não encontrado');
      }

      users[userIndex] = { ...users[userIndex], ...updates };
      const updatedContent = btoa(JSON.stringify(users));

      await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Atualização de dados do usuário ${userId}`,
          committer: {
            name: 'Admin',
            email: 'admin@example.com'
          },
          content: updatedContent,
          sha: data.sha
        })
      });
    } catch (error) {
      console.error('Erro ao atualizar o usuário:', error);
    }
  }

  async function deleteUser(userId) {
    if (!confirm(`Tem certeza que deseja excluir o usuário ${userId}?`)) return;

    try {
      const response = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Erro ao buscar os dados para exclusão');
      }

      const data = await response.json();
      const decodedContent = atob(data.content);
      const users = JSON.parse(decodedContent);

      const userIndex = users.findIndex(user => user.id === userId);
      if (userIndex === -1) {
        throw new Error('Usuário não encontrado');
      }

      users.splice(userIndex, 1);
      const updatedContent = btoa(JSON.stringify(users));

      await fetch(url, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Exclusão de usuário ${userId}`,
          committer: {
            name: 'Admin',
            email: 'admin@example.com'
          },
          content: updatedContent,
          sha: data.sha
        })
      });

      showToast('Usuário excluído com sucesso!', 3000, 'success');
      fetchUsers();
    } catch (error) {
      console.error('Erro ao excluir o usuário:', error);
    }
  }

  document.getElementById('addUser').addEventListener('click', function() {
    window.location.href = 'https://ghosthszz.github.io/Vendas/frontend/paginas/login/register.html';
  });

  async function banUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) {
      showToast("Usuário não encontrado.", 3000, 'error');
      return;
    }

    const banFilePath = `ban/${userId}.json`; // Caminho do arquivo de banimento

    if (user.ban) {
      // Desbanir usuário, alterando o campo 'ban' para false
      await updateUser(userId, { ban: false });
      showToast(`Usuário ${userId} desbanido com sucesso!`, 3000, 'success');

      // Remover o arquivo de banimento do repositório GitHub
      try {
        const fileResponse = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/${banFilePath}`, {
          headers: {
            'Authorization': `token ${token}`
          }
        });

        if (fileResponse.ok) {
          const fileData = await fileResponse.json();
          const sha = fileData.sha; // Pega o sha para excluir o arquivo existente

          const deleteResponse = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/${banFilePath}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Remoção do banimento para ${userId}`,
              committer: {
                name: 'Admin',
                email: 'admin@example.com'
              },
              sha: sha
            })
          });

          if (deleteResponse.ok) {
            console.log('Arquivo de banimento removido com sucesso!');
          } else {
            throw new Error('Erro ao remover o arquivo de banimento no GitHub');
          }
        } else {
          console.log('Arquivo de banimento não encontrado no repositório.');
        }
      } catch (error) {
        console.error('Erro ao remover o arquivo de banimento:', error);
        showToast('Erro ao remover o arquivo de banimento!', 3000, 'error');
      }

    } else {
      // Banir usuário
      const message = prompt("Digite a mensagem de banimento (máximo 300 caracteres):");
      if (!message || message.length > 300) {
        showToast("Mensagem inválida!", 3000, 'error');
        return;
      }

      // Atualizar o usuário para banido
      await updateUser(userId, { ban: true, banMessage: message });

      // Enviar o arquivo de banimento para o GitHub
      const banData = btoa(JSON.stringify({ userId, message }));

      try {
        // Verificar se o arquivo de banimento já existe no GitHub
        const fileResponse = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/${banFilePath}`, {
          headers: {
            'Authorization': `token ${token}`
          }
        });

        let sha = null;
        if (fileResponse.ok) {
          const fileData = await fileResponse.json();
          sha = fileData.sha; // Pega o sha para atualizar o arquivo existente
        }

        // Enviar ou atualizar o arquivo de banimento no GitHub
        const response = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/${banFilePath}`, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Registro de banimento para ${userId}`,
            committer: {
              name: 'Admin',
              email: 'admin@example.com'
            },
            content: banData,
            sha: sha // Envia o sha se o arquivo já existir, ou omite para criar um novo
          })
        });

        if (response.ok) {
          showToast(`Usuário ${userId} banido com sucesso!`, 3000, 'success');
        } else {
          throw new Error('Erro ao salvar o arquivo de banimento no GitHub');
        }
      } catch (error) {
        console.error('Erro ao salvar o arquivo de banimento:', error);
        showToast('Erro ao salvar o arquivo de banimento!', 3000, 'error');
      }
    }
  }

function filterUsers(event) {
  const searchTerm = event.target.value.toLowerCase();

  const filteredUsers = allUsers.filter(user => {
    return (
      (user.name && user.name.toLowerCase().includes(searchTerm)) ||
      (user.id && user.id.toLowerCase().includes(searchTerm)) ||
      (user.email && user.email.toLowerCase().includes(searchTerm)) ||
      (user.email_code && user.email_code.toLowerCase().includes(searchTerm)) ||
      (user.saldo && user.saldo.toString().toLowerCase().includes(searchTerm)) ||
      (user.expirationDate && user.expirationDate.toLowerCase().includes(searchTerm))
    );
  });

  displayUsers(filteredUsers);
}












function downloadUserData(userId) {
  const user = allUsers.find(u => u.id === userId);
  if (!user) {
    showToast("Usuário não encontrado.", 3000, 'error');
    return;
  }

  const senhaCifrada = btoa(user.password || '');

  const userDataText = `
ID: ${user.id}
Nome: ${user.name}
Usuario: ${user.email}
Senha: ${senhaCifrada}
Email: ${user.email_code}
Amigos: ${user.friends}
Saldo: ${user.saldo}
Cupom: ${user.cupom || 'Nenhum'}
Status: ${user.active ? 'Ativo' : 'Inativo'}
Banido: ${user.ban ? 'Sim' : 'Não'}
Packs: ${user.id_links}

COMPRAS PELO SITE: ${user.id_compras}
`.trim();

  const encoded = encodeURIComponent(userDataText);

  const link = document.createElement("a");
  link.href = "data:text/plain;charset=utf-8," + encoded;
  link.download = `DADOS_${user.id}.txt`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}










function alterarSaldo(userId, valor) {
    if (isNaN(valor) || valor === 0) {
        showToast('Valor inválido para alteração de saldo.', 3000, 'error');
        return;
    }

    fetch(url, {
        headers: {
            Authorization: `token ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        let content = atob(data.content);
        let jsonData = JSON.parse(content);

        let user = jsonData.find(u => u.id === userId);

        if (!user) {
            showToast('Usuário não encontrado.', 3000, 'error');
            return;
        }

        let currentBalance = parseFloat(user.saldo.replace('R$', '').replace('.', '').replace(',', '.'));
        let newBalance = currentBalance + valor;

        if (newBalance < 0) {
            showToast('Saldo insuficiente para esta operação.', 3000, 'error');
            return;
        }

        // Limitar a um máximo, se quiser, por exemplo 900
        if (newBalance < '1,00') {
            showToast('O saldo mínimo é R$1,00.', 3000, 'error');
            return;
        }

        user.saldo = `R$${newBalance.toFixed(2).replace('.', ',')}`;

        let updatedContent = btoa(JSON.stringify(jsonData));

        fetch(url, {
            method: 'PUT',
            headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Alteração de saldo',
                content: updatedContent,
                sha: data.sha
            })
        })
        .then(() => {
            showToast(`Saldo atualizado com sucesso! Novo saldo: ${user.saldo}`, 3000, 'success');
        })
        .catch(error => {
            console.error('Erro ao atualizar dados:', error);
            showToast('Erro ao atualizar saldo.', 3000, 'error');
        });
    })
    .catch(error => {
        console.error('Erro ao carregar dados:', error);
        showToast('Erro ao carregar dados do usuário.', 3000, 'error');
    });
}
function alterarSaldoPrompt(userId, adicionar) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) {
        showToast("Usuário não encontrado.", 3000, 'error');
        return;
    }

    let valorStr = prompt(`Digite o valor para ${adicionar ? 'adicionar' : 'remover'}.\nSaldo atual: ${user.saldo}`);
    if (!valorStr) return;

    let valor = parseFloat(valorStr.replace(/\./g, '').replace(',', '.'));
    if (isNaN(valor) || valor <= 0) {
        showToast('Valor inválido.', 3000, 'error');
        return;
    }

    if (!adicionar) valor = -valor;

    alterarSaldo(userId, valor);
}


let apiData = [];
let fileSha = ''; // SHA do arquivo no GitHub

// Exibir ou ocultar o loader com mensagem dinâmica
function showLoader(show) {
    const loaderOverlay = document.getElementById('loaderOverlay');
    loaderOverlay.style.display = show ? 'flex' : 'none';
}


// Buscar o JSON no GitHub
async function fetchApiData() {
    showLoader(true, 'Buscando APIs...');

    try {
        const response = await fetch(url1, {
            headers: { Authorization: `token ${token}` }
        });

        if (!response.ok) throw new Error('Erro ao buscar a API: ' + response.status);

        const result = await response.json();

        let content;

        if (result.content) {
            // Se vier em Base64
            content = atob(result.content.replace(/\n/g, ''));
        } else {
            // Se já for JSON puro (raw)
            content = JSON.stringify(result);
        }

        apiData = JSON.parse(content);
        fileSha = result.sha || ''; // SHA pode não existir se for raw

        setTimeout(() => {
            showLoader(false);
            openModal();
        }, 2000);

    } catch (error) {
        console.error(error);
        showLoader(false);
        showToast(`Erro ao buscar APIs: ${error.message}`, 3000, 'error');
    }
}


// Abrir o modal e listar as APIs
function openModal() {
    const apiList = document.getElementById('apiList');
    apiList.innerHTML = '';

    apiData.forEach((api, index) => {
        const apiItem = document.createElement('div');
        apiItem.className = 'api-item';

        const apiName = document.createElement('span');
        apiName.textContent = api.API;

        // Define status disponível para cada API
        let statuses = ['ACTIVE', 'OFFLINE'];
        if (api.API === 'ALERT') statuses = ['ONLINE', 'OFFLINE'];

        const statusSelect = document.createElement('select');
        statuses.forEach(status => {
            const option = new Option(status, status, api.STATUS === status, api.STATUS === status);
            statusSelect.appendChild(option);
        });

        // Campo para definir a data (UPDATE)
        const dateInput = document.createElement('input');
        dateInput.type = 'datetime-local';
        dateInput.className = 'date-input';
        dateInput.style.display = (api.API === 'UPDATE' && api.STATUS === 'ACTIVE') ? 'inline-block' : 'none';
        dateInput.value = api.DATA ? new Date(api.DATA).toISOString().slice(0, 16) : '';
        dateInput.addEventListener('change', () => {
            apiData[index].DATA = dateInput.value;
        });

        // Campos específicos para ALERT
        let alertDateInput = null;
        let alertFileInput = null;
        let alertImg = null;
        let alertUploadBtn = null;

        if (api.API === 'ALERT') {
            // Input para data futura
            alertDateInput = document.createElement('input');
            alertDateInput.type = 'datetime-local';
            alertDateInput.style.display = (api.STATUS === 'ONLINE') ? 'inline-block' : 'none';
            alertDateInput.value = api.DATA ? new Date(api.DATA).toISOString().slice(0, 16) : '';
            alertDateInput.addEventListener('change', () => {
                const selectedDate = new Date(alertDateInput.value);
                if (selectedDate <= new Date()) {
                    showToast('A data deve ser futura!', 3000, 'error');
                    alertDateInput.value = '';
                } else {
                    apiData[index].DATA = alertDateInput.value;
                }
            });

            // Imagem atual do ALERT
            alertImg = document.createElement('img');
            alertImg.style.display = (api.STATUS === 'ONLINE' && api.URL) ? 'block' : 'none';
            alertImg.style.width = '100px';
            alertImg.style.height = '100px';
            alertImg.style.objectFit = 'cover';
            alertImg.style.marginTop = '5px';
            alertImg.src = api.URL || '';

            // Input para selecionar nova imagem
            alertFileInput = document.createElement('input');
            alertFileInput.type = 'file';
            alertFileInput.accept = 'image/*';
            alertFileInput.style.display = 'none';

            // Botão para trocar a imagem
            alertUploadBtn = document.createElement('button');
            alertUploadBtn.textContent = 'Trocar Imagem';
            alertUploadBtn.style.display = (api.STATUS === 'ONLINE') ? 'inline-block' : 'none';
            alertUploadBtn.addEventListener('click', () => {
                alertFileInput.click();
            });

            // Upload da nova imagem
            alertFileInput.addEventListener('change', async () => {
                const file = alertFileInput.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async () => {
                    const base64Content = btoa(
                        new Uint8Array(reader.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    const fileName = encodeURIComponent(file.name);

                    try {
                        const response = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/files/${fileName}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github+json'
                            },
                            body: JSON.stringify({
                                message: `Upload da imagem ${fileName}`,
                                content: base64Content
                            })
                        });

                        if (!response.ok) throw new Error('Falha no upload');

                        apiData[index].URL = `https://ghosthszz.github.io/Vendas/frontend/files/${file.name}`;
                        alertImg.src = apiData[index].URL;
                        alertImg.style.display = 'block';
                        showToast('Imagem enviada com sucesso!', 3000, 'success');
                    } catch (err) {
                        console.error(err);
                        showToast('Erro ao enviar a imagem!', 3000, 'error');
                    }
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // Atualiza visibilidade ao mudar status
        statusSelect.addEventListener('change', async () => {
            const oldStatus = apiData[index].STATUS;
            apiData[index].STATUS = statusSelect.value;

            // UPDATE
            if (api.API === 'UPDATE') {
                if (statusSelect.value === 'ACTIVE') {
                    dateInput.style.display = 'inline-block';
                } else {
                    dateInput.style.display = 'none';
                    delete apiData[index].DATA;
                }
            }

            // ALERT
            if (api.API === 'ALERT') {
                if (statusSelect.value === 'ONLINE') {
                    alertDateInput.style.display = 'inline-block';
                    alertUploadBtn.style.display = 'inline-block';
                    if (apiData[index].URL) alertImg.style.display = 'block';
                } else {
                    alertDateInput.style.display = 'none';
                    alertUploadBtn.style.display = 'none';
                    alertImg.style.display = 'none';

                    // Remove a imagem antiga se havia
                    if (apiData[index].URL) {
                        const fileName = apiData[index].URL.split('/').pop();
                        try {
                            const fileResponse = await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/files/${fileName}`, {
                                headers: { 'Authorization': `token ${token}` }
                            });

                            if (fileResponse.ok) {
                                const fileData = await fileResponse.json();
                                await fetch(`https://api.github.com/repos/ghosthszz/Vendas/contents/frontend/files/${fileName}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': `token ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        message: `Remoção da imagem ${fileName}`,
                                        committer: { name: 'Admin', email: 'admin@example.com' },
                                        sha: fileData.sha
                                    })
                                });
                                showToast('Imagem antiga removida com sucesso!', 3000, 'success');
                            }
                        } catch (err) {
                            console.error(err);
                            showToast('Erro ao remover a imagem antiga!', 3000, 'error');
                        }
                    }

                    delete apiData[index].DATA;
                    delete apiData[index].URL;
                }
            }
        });

        apiItem.appendChild(apiName);
        apiItem.appendChild(statusSelect);
        if (api.API === 'UPDATE') apiItem.appendChild(dateInput);
        if (api.API === 'ALERT') {
            apiItem.appendChild(alertDateInput);
            apiItem.appendChild(alertUploadBtn);
            apiItem.appendChild(alertFileInput);
            apiItem.appendChild(alertImg);
        }

        apiList.appendChild(apiItem);
    });

    document.getElementById('apiModal').style.display = 'flex';
}


// Fechar o modal
function closeModal() {
    document.getElementById('apiModal').style.display = 'none';
}

// Eventos do modal
document.querySelector('.close').addEventListener('click', closeModal);
window.addEventListener('click', event => {
    if (event.target.classList.contains('modal')) closeModal();
});

// Salvar alterações no GitHub com loader de 20s e mensagens dinâmicas
document.getElementById('saveChanges').addEventListener('click', async () => {
    const messages = [
        "Enviando ao motor",
        "Solicitando alterações",
        "Verificando APIs"
    ];

    showLoader(true, messages[0]);

    let msgIndex = 0;
    const loaderText = document.querySelector('#wifi-loader .text');

    // Intervalo para trocar as mensagens a cada ~6.5 segundos
    const intervalId = setInterval(() => {
        msgIndex++;
        if (msgIndex < messages.length) {
            loaderText.setAttribute('data-text', messages[msgIndex]);
        }
    }, 6500);

    try {
        const updatedContent = btoa(JSON.stringify(apiData, null, 2));

        const response = await fetch(url1, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Update API status',
                content: updatedContent,
                sha: fileSha
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message);
        }

        // Mantém o loader ativo por 20 segundos
        await new Promise(resolve => setTimeout(resolve, 20000));

        clearInterval(intervalId);
        showLoader(false);
        closeModal();
        showToast('success "code:200"', 3000, 'success');

    } catch (error) {
        clearInterval(intervalId);
        showLoader(false);
        console.error(error);
        showToast(`Erro ao salvar: ${error.message}`, 3000, 'error');
    }
});

// Botão que inicia a busca da API
document.getElementById('checkAPI').addEventListener('click', fetchApiData);


</script>
</body>
</html>
